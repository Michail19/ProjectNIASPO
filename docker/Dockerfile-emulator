FROM ubuntu:20.04

# Установка переменной окружения для предотвращения интерактивного режима
ENV DEBIAN_FRONTEND=noninteractive

# Настройка временной зоны
RUN apt update && apt install -y tzdata && \
    ln -fs /usr/share/zoneinfo/Europe/London /etc/localtime && \
    dpkg-reconfigure --frontend noninteractive tzdata

# Установка необходимых инструментов
RUN apt update && apt install -y \
    wget \
    unzip \
    openjdk-11-jdk \
    libgl1-mesa-dev \
    libqt5widgets5 \
    adb \
    lib32stdc++6 \
    lib32z1 \
    qemu-kvm \
    x11vnc \
    xvfb \
    git \
    fluxbox \
    && rm -rf /var/lib/apt/lists/*

RUN apt update && apt install -y \
    libgl1-mesa-glx \
    libgl1-mesa-dri \
    libsdl1.2debian \
    lib32gcc1 \
    && rm -rf /var/lib/apt/lists/*

# Установка Android SDK
ENV ANDROID_SDK_ROOT=/opt/android-sdk
RUN mkdir -p $ANDROID_SDK_ROOT

RUN wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O /cmdline-tools.zip && \
    unzip /cmdline-tools.zip -d $ANDROID_SDK_ROOT && \
    mv $ANDROID_SDK_ROOT/cmdline-tools $ANDROID_SDK_ROOT/tools && \
    rm /cmdline-tools.zip

# Установка компонентов Android SDK
RUN yes | $ANDROID_SDK_ROOT/tools/bin/sdkmanager --licenses
RUN $ANDROID_SDK_ROOT/tools/bin/sdkmanager "platform-tools" "platforms;android-30" "system-images;android-30;google_apis;x86_64" "emulator"

# Создание виртуального устройства AVD
RUN echo "no" | $ANDROID_SDK_ROOT/tools/bin/avdmanager create avd -n test_avd -k "system-images;android-30;google_apis;x86_64" --device "pixel_4"

# Копирование скрипта для запуска эмулятора
COPY ./docker/run-emulator.sh /usr/local/bin/run-emulator.sh
RUN chmod +x /usr/local/bin/run-emulator.sh

# Установка adb
RUN apt update && apt install -y android-tools-adb

# Открытие необходимых портов
EXPOSE 5554 5555 5900

# Команда для запуска скрипта запуска эмулятора
CMD ["run-emulator.sh"]
